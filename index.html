<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Simulation – Python Code</title>

    <!-- Highlight.js CSS (Theme) -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">

    <!-- Highlight.js Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Python-Sprache laden (optional, aber besser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            hljs.highlightAll();
        });
    </script>
</head>
<body>
    <h1>Simulation Motorleistung – Python Code</h1>



<h2>Publisher</h2>
    
	<pre><code class="language-python">
'''
IoT-Schicht 1
- Publish mqtt-basierte Daten (simulierter Prozess)

angepasst: Simulation Motorleistung P(t) mit verstellbaren Parametern über MQTT

Doku:
https://pypi.org/project/paho-mqtt/#description
'''

import time
import datetime
import json
import numpy as np
import paho.mqtt.client as mqtt

# --------------------------------------------------------------
# Parameterblock
mq_host = "127.0.0.1"              # lokaler PC / Broker
mq_topic_data = "Maschinensimulation"          # Topic für Simulationsdaten
mq_topic_params = "Maschinensimulation/params" # Topic für Parameter von Node-RED
# --------------------------------------------------------------

# Simulationsparameter (Standardwerte)
params = {
    "P0": 0.9,      # Startleistung in kW
    "Pend": 0.5,    # Endleistung in kW
    "tau_s": 600.0  # Zeitkonstante in Sekunden (z.B. 600s = 10min)
}

start_time = time.time()  # Referenzzeit für t

# --------------------------------------------------------------
# MQTT-Callbacks
# --------------------------------------------------------------

def on_connect(client, userdata, flags, rc):
    print("Connected with result code " + str(rc))
    # Parameter-Topic abonnieren (Node-RED schickt hier JSON)
    client.subscribe(mq_topic_params)
    print(f"Subscribed to params topic: {mq_topic_params}")


def on_message(client, userdata, msg):
    global params
    if msg.topic == mq_topic_params:
        try:
            payload = msg.payload.decode("utf-8")
            new_params = json.loads(payload)
            print("Parameter empfangen:", new_params)

            # Nur bekannte Keys übernehmen
            for k in params.keys():
                if k in new_params:
                    params[k] = float(new_params[k])

            print("Aktive Parameter:", params)
        except Exception as e:
            print("Fehler beim Verarbeiten der Parameter:", e)

# __main__ ======================================================
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

client.connect(mq_host, 1883, 60)
client.loop_start()

# Generieren von simulierten Daten -----------
cnt = 0
print("Starte Simulationsschleife...")

try:
    while True:
        time.sleep(1)  # Schrittweite 1 s
        cnt += 1
        ts = datetime.datetime.now()

        # Simulationszeit seit Start (Sekunden)
        t_s = time.time() - start_time

        # Exponentiell abfallende Motorleistung in kW
        P0 = params["P0"]
        Pend = params["Pend"]
        tau_s = params["tau_s"]

        P_kW = Pend + (P0 - Pend) * np.exp(-t_s / tau_s)

        # python-dict beschreibt den Daten-Block (payload)
        PL = {
            "t_unix": time.time(),        # unix-Zeit
            "ts": str(ts),                # Zeitstempel als String
            "t_s": t_s,                   # Simulationszeit in s
            "cnt": cnt,                   # Zähler (optional)
            "P_kW": float(P_kW),          # simulierte Motorleistung
            "P0": P0,
            "Pend": Pend,
            "tau_s": tau_s
        }

        # Umwandeln in ein json-Objekt
        jPL = json.dumps(PL)

        # versenden (publish)
        client.publish(topic=mq_topic_data, payload=jPL)
        print(PL)

except KeyboardInterrupt:
    print("Beende Simulation...")

finally:
    client.loop_stop()
    client.disconnect()

	 </code></pre>





<h2>Subscriber</h2>

<pre><code class="language-python">


import paho.mqtt.client as mqtt
from pymongo import MongoClient
import json
# --------------------------------------------------------------
# Parameterblock
mdb_mq_host = "127.0.0.1"        # lokaler PC
mdb_db = "Motorleistung"
mdb_col = "Simulation"       # letzte IP-Adr-Nr
mq_topic = "Simulation_Motor"   # letzte IP-Adr-Nr

# --------------------------------------------------------------

cnt = 0

class mqClient():
    def __init__(self,col):
        self.col = col
        
    def on_connect(self,client, userdata, flags, rc):
        print("Connected with result code " + str(rc))
        client.subscribe("Simulation_Motor")

    def on_message(self,client, userdata, msg):
        global cnt
        cnt +=1
        print(cnt, '     ',msg.topic + " " + str(msg.payload))
        # payload enthält ein json-Objekt mit allen gesendeten Datenwerten {key1:value1, key2:value2}
        data = json.loads(msg.payload)
        print(data)
        # Schreiben in die MongoDB
        result = self.col.insert_one(data)

# __main__ ======================================================
mo_client = MongoClient(mdb_mq_host, 27017)
db = mo_client[mdb_db]
col = db[mdb_col]
# col.drop()      # Löschen der bereits erzeugten Collection (ggf. auskommentieren...)

mqC = mqClient(col)

client = mqtt.Client()
client.on_connect = mqC.on_connect
client.on_message = mqC.on_message

client.connect(mdb_mq_host, 1883, 60)

client.loop_forever()

    </code></pre>
</body>
</html>
